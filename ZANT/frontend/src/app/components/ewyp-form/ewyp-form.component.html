<div class="ewyp-form-container">
  <h1>Zg≈Çoszenie wypadku przy pracy</h1>
  <p class="subtitle">Wype≈Çnij formularz krok po kroku. Asystent pomo≈ºe Ci uzupe≈Çniƒá wymagane informacje.</p>

  <div class="progress-indicator">
    <div class="steps">
      <div *ngFor="let step of [1,2,3,4,5,6,7]"
           [class.active]="currentStep + 1 === step"
           [class.completed]="currentStep + 1 > step"
           class="step">
        <div class="step-circle">{{ step }}</div>
        <div class="step-label">
          <div class="step-title-small">{{ getStepTitleForProgress(step) }}</div>
          <div class="step-subtitle-small">{{ getStepSubtitleForProgress(step) }}</div>
        </div>
      </div>
    </div>
  </div>

  <form [formGroup]="reportForm" (ngSubmit)="onSubmit()">

    <!-- Krok 0: Identyfikacja dzia≈Çalno≈õci gospodarczej -->
    <div *ngIf="currentStep === 0" class="form-step identification-step">
      <div class="step-header">
        <div class="search-icon">üîç</div>
        <h2>Identyfikacja dzia≈Çalno≈õci gospodarczej</h2>
        <p class="step-description">Podaj NIP lub REGON swojej firmy, aby≈õmy mogli automatycznie pobraƒá dane.</p>
      </div>

      <div class="search-section">
        <label class="search-label">NIP lub REGON</label>
        <div class="search-input-group">
          <input
            type="text"
            [(ngModel)]="nipRegonSearch"
            [ngModelOptions]="{standalone: true}"
            placeholder="np. 1234567890"
            class="search-input"
            (keyup.enter)="searchCompanyData()">
          <button
            type="button"
            (click)="searchCompanyData()"
            [disabled]="isSearching"
            class="search-button">
            <span *ngIf="!isSearching">üîç Szukaj</span>
            <span *ngIf="isSearching">‚è≥ Wyszukiwanie...</span>
          </button>
        </div>
        <p class="test-nip-hint">Testowe NIP-y: 1234567890, 9876543210, 5555555555</p>

        <div *ngIf="searchError" class="alert alert-error">
          {{ searchError }}
        </div>
      </div>

      <!-- Company Data Results -->
      <div *ngIf="companyData" class="company-data-result">
        <div class="result-header">
          <span class="check-icon">‚úÖ</span>
          <h3>Znaleziono dane dzia≈Çalno≈õci</h3>
        </div>

        <div class="company-info">
          <div class="info-row">
            <div class="info-icon">üè¢</div>
            <div class="info-content">
              <div class="info-label">Nazwa firmy</div>
              <div class="info-value">{{ companyData.name }}</div>
            </div>
            <div class="info-content">
              <div class="info-label">NIP</div>
              <div class="info-value">{{ companyData.nip }}</div>
            </div>
          </div>

          <div class="info-row">
            <div class="info-label-standalone">REGON</div>
            <div class="info-value-standalone">{{ companyData.regon }}</div>
            <div class="info-label-standalone">PKD</div>
            <div class="info-value-standalone">{{ companyData.pkd }}</div>
          </div>

          <div class="info-row">
            <div class="info-label-standalone">Adres siedziby</div>
            <div class="info-value-standalone">{{ companyData.address }}</div>
          </div>
        </div>

        <button
          type="button"
          (click)="continueWithCompanyData()"
          class="continue-button">
          Kontynuuj zg≈Çoszenie
        </button>
      </div>
    </div>

    <!-- Krok 1: Opis wypadku (wcze≈õniej Krok 3) -->
    <div *ngIf="currentStep === 1" class="form-step" formGroupName="accidentInfo">
      <h2>Informacje o wypadku</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Data wypadku *</label>
          <input type="date" formControlName="accidentDate" class="form-control" [class.ng-invalid]="reportForm.get('accidentInfo.accidentDate')?.invalid && reportForm.get('accidentInfo.accidentDate')?.touched">
          <span *ngIf="reportForm.get('accidentInfo.accidentDate')?.invalid && reportForm.get('accidentInfo.accidentDate')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
        <div class="form-group">
          <label>Godzina wypadku *</label>
          <input type="time" formControlName="accidentTime" class="form-control" [class.ng-invalid]="reportForm.get('accidentInfo.accidentTime')?.invalid && reportForm.get('accidentInfo.accidentTime')?.touched">
          <span *ngIf="reportForm.get('accidentInfo.accidentTime')?.invalid && reportForm.get('accidentInfo.accidentTime')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Planowana godzina rozpoczƒôcia pracy *</label>
          <input type="time" formControlName="plannedWorkStartTime" class="form-control" [class.ng-invalid]="reportForm.get('accidentInfo.plannedWorkStartTime')?.invalid && reportForm.get('accidentInfo.plannedWorkStartTime')?.touched">
          <span *ngIf="reportForm.get('accidentInfo.plannedWorkStartTime')?.invalid && reportForm.get('accidentInfo.plannedWorkStartTime')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
        <div class="form-group">
          <label>Planowana godzina zako≈Ñczenia pracy *</label>
          <input type="time" formControlName="plannedWorkEndTime" class="form-control" [class.ng-invalid]="reportForm.get('accidentInfo.plannedWorkEndTime')?.invalid && reportForm.get('accidentInfo.plannedWorkEndTime')?.touched">
          <span *ngIf="reportForm.get('accidentInfo.plannedWorkEndTime')?.invalid && reportForm.get('accidentInfo.plannedWorkEndTime')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
      </div>

      <div class="form-group">
        <label>Miejsce wypadku *</label>
        <textarea formControlName="placeOfAccident" class="form-control" rows="2" [class.ng-invalid]="reportForm.get('accidentInfo.placeOfAccident')?.invalid && reportForm.get('accidentInfo.placeOfAccident')?.touched"></textarea>
        <span *ngIf="reportForm.get('accidentInfo.placeOfAccident')?.invalid && reportForm.get('accidentInfo.placeOfAccident')?.touched" class="validation-error">
          To pole jest wymagane
        </span>
      </div>

      <div class="form-group">
        <label>Opis doznanego urazu *</label>
        <textarea formControlName="injuriesDescription" class="form-control" rows="3" [class.ng-invalid]="reportForm.get('accidentInfo.injuriesDescription')?.invalid && reportForm.get('accidentInfo.injuriesDescription')?.touched"></textarea>
        <span *ngIf="reportForm.get('accidentInfo.injuriesDescription')?.invalid && reportForm.get('accidentInfo.injuriesDescription')?.touched" class="validation-error">
          To pole jest wymagane
        </span>
      </div>

      <div class="form-group">
        <label>Okoliczno≈õci i przyczyny zdarzenia *</label>
        <p class="field-description">Opisz szczeg√≥≈Çowo co siƒô sta≈Ço, jak dosz≈Ço do wypadku i jakie by≈Çy jego przyczyny.</p>
        <textarea formControlName="circumstancesAndCauses" class="form-control" rows="3" [class.ng-invalid]="reportForm.get('accidentInfo.circumstancesAndCauses')?.invalid && reportForm.get('accidentInfo.circumstancesAndCauses')?.touched"></textarea>
        <span *ngIf="reportForm.get('accidentInfo.circumstancesAndCauses')?.invalid && reportForm.get('accidentInfo.circumstancesAndCauses')?.touched" class="validation-error">
          To pole jest wymagane
        </span>

        <button type="button"
                (click)="checkCircumstancesDescription()"
                [disabled]="isLoadingQuestions"
                class="btn btn-info btn-assistant">
          <span *ngIf="!isLoadingQuestions">ü§ñ Asystent AI - sprawd≈∫ opis</span>
          <span *ngIf="isLoadingQuestions">‚è≥ Trwa sprawdzanie...</span>
        </button>

        <!-- AI Assistant Suggestions -->
        <div *ngIf="showCircumstancesAssistant" class="assistant-suggestions">
          <div *ngIf="isLoadingQuestions" class="loading-message">
            Asystent AI analizuje opis zdarzenia...
          </div>

          <div *ngIf="!isLoadingQuestions && !!circumstancesQuestionsError" class="error-message">
            {{ circumstancesQuestionsError }}
          </div>

          <div *ngIf="!isLoadingQuestions && !circumstancesQuestionsError && circumstancesQuestions.length > 0" class="questions-container">
            <h4>üìã Sugestie Asystenta AI</h4>
            <p class="assistant-intro">Aby doprecyzowaƒá opis zdarzenia, rozwa≈º odpowied≈∫ na poni≈ºsze pytania:</p>
            <ul class="questions-list">
              <li *ngFor="let question of circumstancesQuestions" class="question-item">
                <strong>{{ question.id }}.</strong> {{ question.text }}
              </li>
            </ul>
          </div>

          <div *ngIf="!isLoadingQuestions && circumstancesQuestions.length === 0 && !circumstancesQuestionsError" class="no-questions-message">
            ‚úÖ Opis zdarzenia jest wystarczajƒÖco szczeg√≥≈Çowy. Nie ma dodatkowych pyta≈Ñ.
          </div>

        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="firstAidGiven">
          Udzielono pierwszej pomocy
        </label>
      </div>

      <div class="form-group">
        <label>Miejsce udzielenia pierwszej pomocy <span *ngIf="reportForm.get('accidentInfo.firstAidGiven')?.value">*</span></label>
        <input type="text" formControlName="firstAidFacility" class="form-control" [class.ng-invalid]="reportForm.get('accidentInfo.firstAidFacility')?.invalid && reportForm.get('accidentInfo.firstAidFacility')?.touched">
        <span *ngIf="reportForm.get('accidentInfo.firstAidFacility')?.invalid && reportForm.get('accidentInfo.firstAidFacility')?.touched" class="validation-error">
          To pole jest wymagane gdy udzielono pierwszej pomocy
        </span>
      </div>

      <div class="form-group">
        <label>Organ prowadzƒÖcy czynno≈õci wyja≈õniajƒÖce <span *ngIf="reportForm.get('accidentInfo.firstAidGiven')?.value">*</span></label>
        <input type="text" formControlName="investigatingAuthority" class="form-control" [class.ng-invalid]="reportForm.get('accidentInfo.investigatingAuthority')?.invalid && reportForm.get('accidentInfo.investigatingAuthority')?.touched">
        <span *ngIf="reportForm.get('accidentInfo.investigatingAuthority')?.invalid && reportForm.get('accidentInfo.investigatingAuthority')?.touched" class="validation-error">
          To pole jest wymagane gdy udzielono pierwszej pomocy
        </span>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="accidentDuringMachineOperation">
          Wypadek podczas obs≈Çugi maszyny
        </label>
      </div>

      <div class="form-group">
        <label>Opis stanu technicznego i u≈ºytkowania maszyny <span *ngIf="reportForm.get('accidentInfo.accidentDuringMachineOperation')?.value">*</span></label>
        <textarea formControlName="machineConditionDescription" class="form-control" rows="2" [class.ng-invalid]="reportForm.get('accidentInfo.machineConditionDescription')?.invalid && reportForm.get('accidentInfo.machineConditionDescription')?.touched"></textarea>
        <span *ngIf="reportForm.get('accidentInfo.machineConditionDescription')?.invalid && reportForm.get('accidentInfo.machineConditionDescription')?.touched" class="validation-error">
          To pole jest wymagane gdy wypadek nastƒÖpi≈Ç podczas obs≈Çugi maszyny
        </span>
      </div>
    </div>

    <!-- Krok 2: Dane osoby poszkodowanej -->
    <div *ngIf="currentStep === 2" class="form-step" formGroupName="injuredPerson">
      <h2>Dane osoby poszkodowanej</h2>

      <div class="form-group">
        <label>PESEL *</label>
        <input type="text" formControlName="pesel" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.pesel')?.invalid && reportForm.get('injuredPerson.pesel')?.touched">
        <span *ngIf="reportForm.get('injuredPerson.pesel')?.hasError('required') && reportForm.get('injuredPerson.pesel')?.touched" class="validation-error">
          To pole jest wymagane
        </span>
        <span *ngIf="reportForm.get('injuredPerson.pesel')?.hasError('pattern') && reportForm.get('injuredPerson.pesel')?.touched" class="validation-error">
          PESEL musi sk≈Çadaƒá siƒô z dok≈Çadnie 11 cyfr
        </span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Imiƒô *</label>
          <input type="text" formControlName="firstName" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.firstName')?.invalid && reportForm.get('injuredPerson.firstName')?.touched">
          <span *ngIf="reportForm.get('injuredPerson.firstName')?.invalid && reportForm.get('injuredPerson.firstName')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
        <div class="form-group">
          <label>Nazwisko *</label>
          <input type="text" formControlName="lastName" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.lastName')?.invalid && reportForm.get('injuredPerson.lastName')?.touched">
          <span *ngIf="reportForm.get('injuredPerson.lastName')?.invalid && reportForm.get('injuredPerson.lastName')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Rodzaj dokumentu to≈ºsamo≈õci *</label>
          <input type="text" formControlName="idDocumentType" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.idDocumentType')?.invalid && reportForm.get('injuredPerson.idDocumentType')?.touched">
          <span *ngIf="reportForm.get('injuredPerson.idDocumentType')?.invalid && reportForm.get('injuredPerson.idDocumentType')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
        <div class="form-group">
          <label>Numer dokumentu to≈ºsamo≈õci *</label>
          <input type="text" formControlName="idDocumentNumber" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.idDocumentNumber')?.invalid && reportForm.get('injuredPerson.idDocumentNumber')?.touched">
          <span *ngIf="reportForm.get('injuredPerson.idDocumentNumber')?.invalid && reportForm.get('injuredPerson.idDocumentNumber')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Data urodzenia *</label>
          <input type="date" formControlName="birthDate" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.birthDate')?.invalid && reportForm.get('injuredPerson.birthDate')?.touched">
          <span *ngIf="reportForm.get('injuredPerson.birthDate')?.invalid && reportForm.get('injuredPerson.birthDate')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
        <div class="form-group">
          <label>Miejsce urodzenia *</label>
          <input type="text" formControlName="birthPlace" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.birthPlace')?.invalid && reportForm.get('injuredPerson.birthPlace')?.touched">
          <span *ngIf="reportForm.get('injuredPerson.birthPlace')?.invalid && reportForm.get('injuredPerson.birthPlace')?.touched" class="validation-error">
            To pole jest wymagane
          </span>
        </div>
      </div>

      <div class="form-group">
        <label>Numer telefonu *</label>
        <input type="tel" formControlName="phoneNumber" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.phoneNumber')?.invalid && reportForm.get('injuredPerson.phoneNumber')?.touched">
        <span *ngIf="reportForm.get('injuredPerson.phoneNumber')?.invalid && reportForm.get('injuredPerson.phoneNumber')?.touched" class="validation-error">
          To pole jest wymagane
        </span>
      </div>

      <h3>Adres zamieszkania osoby poszkodowanej</h3>
      <div formGroupName="address">
        <div class="form-row">
          <div class="form-group">
            <label>Ulica *</label>
            <input type="text" formControlName="street" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.address.street')?.invalid && reportForm.get('injuredPerson.address.street')?.touched">
            <span *ngIf="reportForm.get('injuredPerson.address.street')?.invalid && reportForm.get('injuredPerson.address.street')?.touched" class="validation-error">
              To pole jest wymagane
            </span>
          </div>
          <div class="form-group">
            <label>Numer domu *</label>
            <input type="text" formControlName="houseNumber" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.address.houseNumber')?.invalid && reportForm.get('injuredPerson.address.houseNumber')?.touched">
            <span *ngIf="reportForm.get('injuredPerson.address.houseNumber')?.invalid && reportForm.get('injuredPerson.address.houseNumber')?.touched" class="validation-error">
              To pole jest wymagane
            </span>
          </div>
          <div class="form-group">
            <label>Numer lokalu</label>
            <input type="text" formControlName="apartmentNumber" class="form-control">
            <span class="field-description">Opcjonalne - mo≈ºe byƒá dom</span>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Kod pocztowy *</label>
            <input type="text" formControlName="postalCode" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.address.postalCode')?.invalid && reportForm.get('injuredPerson.address.postalCode')?.touched">
            <span *ngIf="reportForm.get('injuredPerson.address.postalCode')?.invalid && reportForm.get('injuredPerson.address.postalCode')?.touched" class="validation-error">
              To pole jest wymagane
            </span>
          </div>
          <div class="form-group">
            <label>Miejscowo≈õƒá *</label>
            <input type="text" formControlName="city" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.address.city')?.invalid && reportForm.get('injuredPerson.address.city')?.touched">
            <span *ngIf="reportForm.get('injuredPerson.address.city')?.invalid && reportForm.get('injuredPerson.address.city')?.touched" class="validation-error">
              To pole jest wymagane
            </span>
          </div>
          <div class="form-group">
            <label>Nazwa pa≈Ñstwa *</label>
            <input type="text" formControlName="country" class="form-control" [class.ng-invalid]="reportForm.get('injuredPerson.address.country')?.invalid && reportForm.get('injuredPerson.address.country')?.touched">
            <span *ngIf="reportForm.get('injuredPerson.address.country')?.invalid && reportForm.get('injuredPerson.address.country')?.touched" class="validation-error">
              To pole jest wymagane
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Krok 3: Dane osoby zg≈ÇaszajƒÖcej wypadek -->
    <div *ngIf="currentStep === 3" class="form-step" formGroupName="reporter">
      <h2>Dane osoby zg≈ÇaszajƒÖcej wypadek</h2>

      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="isDifferentFromInjuredPerson">
          Zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ ni≈º poszkodowany
        </label>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Imiƒô <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">*</span></label>
          <input type="text" formControlName="firstName" class="form-control" [class.ng-invalid]="reportForm.get('reporter.firstName')?.invalid && reportForm.get('reporter.firstName')?.touched">
          <span *ngIf="reportForm.get('reporter.firstName')?.invalid && reportForm.get('reporter.firstName')?.touched" class="validation-error">
            To pole jest wymagane gdy zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ
          </span>
        </div>
        <div class="form-group">
          <label>Nazwisko <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">*</span></label>
          <input type="text" formControlName="lastName" class="form-control" [class.ng-invalid]="reportForm.get('reporter.lastName')?.invalid && reportForm.get('reporter.lastName')?.touched">
          <span *ngIf="reportForm.get('reporter.lastName')?.invalid && reportForm.get('reporter.lastName')?.touched" class="validation-error">
            To pole jest wymagane gdy zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ
          </span>
        </div>
      </div>

      <div class="form-group">
        <label>PESEL <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">*</span></label>
        <input type="text" formControlName="pesel" class="form-control" [class.ng-invalid]="reportForm.get('reporter.pesel')?.invalid && reportForm.get('reporter.pesel')?.touched">
        <span *ngIf="reportForm.get('reporter.pesel')?.hasError('required') && reportForm.get('reporter.pesel')?.touched" class="validation-error">
          To pole jest wymagane gdy zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ
        </span>
        <span *ngIf="reportForm.get('reporter.pesel')?.hasError('pattern') && reportForm.get('reporter.pesel')?.touched" class="validation-error">
          PESEL musi sk≈Çadaƒá siƒô z dok≈Çadnie 11 cyfr
        </span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Rodzaj dokumentu to≈ºsamo≈õci <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">*</span></label>
          <input type="text" formControlName="idDocumentType" class="form-control" [class.ng-invalid]="reportForm.get('reporter.idDocumentType')?.invalid && reportForm.get('reporter.idDocumentType')?.touched">
          <span *ngIf="reportForm.get('reporter.idDocumentType')?.invalid && reportForm.get('reporter.idDocumentType')?.touched" class="validation-error">
            To pole jest wymagane gdy zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ
          </span>
        </div>
        <div class="form-group">
          <label>Numer dokumentu to≈ºsamo≈õci <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">*</span></label>
          <input type="text" formControlName="idDocumentNumber" class="form-control" [class.ng-invalid]="reportForm.get('reporter.idDocumentNumber')?.invalid && reportForm.get('reporter.idDocumentNumber')?.touched">
          <span *ngIf="reportForm.get('reporter.idDocumentNumber')?.invalid && reportForm.get('reporter.idDocumentNumber')?.touched" class="validation-error">
            To pole jest wymagane gdy zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ
          </span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Data urodzenia <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">*</span></label>
          <input type="date" formControlName="birthDate" class="form-control" [class.ng-invalid]="reportForm.get('reporter.birthDate')?.invalid && reportForm.get('reporter.birthDate')?.touched">
          <span *ngIf="reportForm.get('reporter.birthDate')?.invalid && reportForm.get('reporter.birthDate')?.touched" class="validation-error">
            To pole jest wymagane gdy zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ
          </span>
        </div>
        <div class="form-group">
          <label>Numer telefonu <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">*</span></label>
          <input type="tel" formControlName="phoneNumber" class="form-control" [class.ng-invalid]="reportForm.get('reporter.phoneNumber')?.invalid && reportForm.get('reporter.phoneNumber')?.touched">
          <span *ngIf="reportForm.get('reporter.phoneNumber')?.invalid && reportForm.get('reporter.phoneNumber')?.touched" class="validation-error">
            To pole jest wymagane gdy zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ
          </span>
        </div>
      </div>
    </div>

    <!-- Krok 4: ≈öwiadkowie -->
    <div *ngIf="currentStep === 4" class="form-step">
      <h2>≈öwiadkowie wypadku</h2>

      <div formArrayName="witnesses">
        <div *ngFor="let witness of witnesses.controls; let i = index" [formGroupName]="i" class="witness-group">
          <h3>≈öwiadek wypadku ‚Äì {{ i + 1 }}</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Imiƒô</label>
              <input type="text" formControlName="firstName" class="form-control">
            </div>
            <div class="form-group">
              <label>Nazwisko</label>
              <input type="text" formControlName="lastName" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ulica</label>
              <input type="text" formControlName="street" class="form-control">
            </div>
            <div class="form-group">
              <label>Numer domu</label>
              <input type="text" formControlName="houseNumber" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Miejscowo≈õƒá</label>
              <input type="text" formControlName="city" class="form-control">
            </div>
            <div class="form-group">
              <label>Kod pocztowy</label>
              <input type="text" formControlName="postalCode" class="form-control">
            </div>
          </div>
          <button type="button" (click)="removeWitness(i)" class="btn btn-danger">Usu≈Ñ ≈õwiadka</button>
        </div>
      </div>

      <button type="button" (click)="addWitness()" class="btn btn-secondary">Dodaj ≈õwiadka</button>
    </div>

    <!-- Krok 5: Dokumenty i za≈ÇƒÖczniki -->
    <div *ngIf="currentStep === 5" class="form-step" formGroupName="attachments">
      <h2>Dokumenty i za≈ÇƒÖczniki</h2>

      <div *ngIf="!savedDraftId" class="alert alert-warning">
        Najpierw zapisz wersjƒô roboczƒÖ, aby m√≥c za≈ÇƒÖczyƒá pliki.
      </div>

      <div *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value" class="alert alert-info">
        Zg≈Çoszenie sk≈Çada pe≈Çnomocnik poszkodowanego. Do≈ÇƒÖcz skan pe≈Çnomocnictwa w formacie PDF.
      </div>

      <!-- Hospital Card Copy -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasHospitalCardCopy">
          Kserokopia karty informacyjnej ze szpitala / za≈õwiadczenia o udzieleniu pierwszej pomocy
        </label>

        <div *ngIf="reportForm.get('attachments.hasHospitalCardCopy')?.value" class="file-upload-section">
          <div *ngIf="!reportForm.get('attachments.hospitalCardCopyFilename')?.value" class="file-input-wrapper">
            <input
              type="file"
              accept="application/pdf"
              (change)="onHospitalCardFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedHospitalCardFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedHospitalCardFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadHospitalCardFile()"
              [disabled]="!selectedHospitalCardFile || isUploadingHospitalCard || !savedDraftId"
              class="btn btn-primary btn-sm">
              {{ isUploadingHospitalCard ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
            </button>
            <div *ngIf="hospitalCardUploadError" class="alert alert-error">{{ hospitalCardUploadError }}</div>
          </div>

          <div *ngIf="reportForm.get('attachments.hospitalCardCopyFilename')?.value" class="uploaded-file-info">
            <div class="file-status">
              ‚úÖ Za≈ÇƒÖczony: <strong>{{ reportForm.get('attachments.hospitalCardCopyFilename')?.value }}</strong>
            </div>
            <div class="file-actions">
              <button type="button" (click)="downloadHospitalCardFile()" class="btn btn-secondary btn-sm">üì• Pobierz</button>
              <button type="button" (click)="deleteHospitalCardFile()" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Prosecutor Decision Copy -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasProsecutorDecisionCopy">
          Kserokopia postanowienia prokuratury
        </label>

        <div *ngIf="reportForm.get('attachments.hasProsecutorDecisionCopy')?.value" class="file-upload-section">
          <div *ngIf="!reportForm.get('attachments.prosecutorDecisionCopyFilename')?.value" class="file-input-wrapper">
            <input
              type="file"
              accept="application/pdf"
              (change)="onProsecutorDecisionFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedProsecutorDecisionFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedProsecutorDecisionFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadProsecutorDecisionFile()"
              [disabled]="!selectedProsecutorDecisionFile || isUploadingProsecutorDecision || !savedDraftId"
              class="btn btn-primary btn-sm">
              {{ isUploadingProsecutorDecision ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
            </button>
            <div *ngIf="prosecutorDecisionUploadError" class="alert alert-error">{{ prosecutorDecisionUploadError }}</div>
          </div>

          <div *ngIf="reportForm.get('attachments.prosecutorDecisionCopyFilename')?.value" class="uploaded-file-info">
            <div class="file-status">
              ‚úÖ Za≈ÇƒÖczony: <strong>{{ reportForm.get('attachments.prosecutorDecisionCopyFilename')?.value }}</strong>
            </div>
            <div class="file-actions">
              <button type="button" (click)="downloadProsecutorDecisionFile()" class="btn btn-secondary btn-sm">üì• Pobierz</button>
              <button type="button" (click)="deleteProsecutorDecisionFile()" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Power of Attorney Copy -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasPowerOfAttorneyCopy">
          Skan pe≈Çnomocnictwa (PDF) <span *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value">(wymagany dla pe≈Çnomocnika)</span>
        </label>

        <div class="validation-error"
             *ngIf="reportForm.get('reporter.isDifferentFromInjuredPerson')?.value && !reportForm.get('attachments.powerOfAttorneyCopyFilename')?.value">
          Za≈ÇƒÖcz skan pe≈Çnomocnictwa, je≈õli zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ ni≈º poszkodowany.
        </div>

        <div *ngIf="reportForm.get('attachments.hasPowerOfAttorneyCopy')?.value" class="file-upload-section">
          <div *ngIf="!reportForm.get('attachments.powerOfAttorneyCopyFilename')?.value" class="file-input-wrapper">
            <input
              type="file"
              accept="application/pdf"
              (change)="onPowerOfAttorneyFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedPowerOfAttorneyFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedPowerOfAttorneyFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadPowerOfAttorneyFile()"
              [disabled]="!selectedPowerOfAttorneyFile || isUploadingPowerOfAttorney || !savedDraftId"
              class="btn btn-primary btn-sm">
              {{ isUploadingPowerOfAttorney ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
            </button>
            <div *ngIf="powerOfAttorneyUploadError" class="alert alert-error">{{ powerOfAttorneyUploadError }}</div>
          </div>

          <div *ngIf="reportForm.get('attachments.powerOfAttorneyCopyFilename')?.value" class="uploaded-file-info">
            <div class="file-status">
              ‚úÖ Za≈ÇƒÖczony: <strong>{{ reportForm.get('attachments.powerOfAttorneyCopyFilename')?.value }}</strong>
            </div>
            <div class="file-actions">
              <button type="button" (click)="downloadPowerOfAttorneyFile()" class="btn btn-secondary btn-sm">üì• Pobierz</button>
              <button type="button" (click)="deletePowerOfAttorneyFile()" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Death Docs Copy -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasDeathDocsCopy">
          Kopie dokument√≥w dotyczƒÖcych zgonu
        </label>

        <div *ngIf="reportForm.get('attachments.hasDeathDocsCopy')?.value" class="file-upload-section">
          <div *ngIf="!reportForm.get('attachments.deathDocsCopyFilename')?.value" class="file-input-wrapper">
            <input
              type="file"
              accept="application/pdf"
              (change)="onDeathDocsFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedDeathDocsFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedDeathDocsFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadDeathDocsFile()"
              [disabled]="!selectedDeathDocsFile || isUploadingDeathDocs || !savedDraftId"
              class="btn btn-primary btn-sm">
              {{ isUploadingDeathDocs ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
            </button>
            <div *ngIf="deathDocsUploadError" class="alert alert-error">{{ deathDocsUploadError }}</div>
          </div>

          <div *ngIf="reportForm.get('attachments.deathDocsCopyFilename')?.value" class="uploaded-file-info">
            <div class="file-status">
              ‚úÖ Za≈ÇƒÖczony: <strong>{{ reportForm.get('attachments.deathDocsCopyFilename')?.value }}</strong>
            </div>
            <div class="file-actions">
              <button type="button" (click)="downloadDeathDocsFile()" class="btn btn-secondary btn-sm">üì• Pobierz</button>
              <button type="button" (click)="deleteDeathDocsFile()" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Other Documents -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasOtherDocuments">
          Inne dokumenty
        </label>

        <div *ngIf="reportForm.get('attachments.hasOtherDocuments')?.value" class="file-upload-section">
          <div class="file-input-wrapper">
            <div class="form-group">
              <label>Nazwa dokumentu:</label>
              <input
                type="text"
                [(ngModel)]="otherDocumentName"
                [ngModelOptions]="{standalone: true}"
                placeholder="Np. Za≈õwiadczenie lekarskie"
                class="form-control">
            </div>
            <input
              type="file"
              accept="application/pdf"
              (change)="onOtherDocFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedOtherDocFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedOtherDocFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadOtherDocFile()"
              [disabled]="!selectedOtherDocFile || isUploadingOtherDoc || !savedDraftId || !otherDocumentName.trim()"
              class="btn btn-primary btn-sm">
              {{ isUploadingOtherDoc ? 'Przesy≈Çanie...' : 'Dodaj dokument' }}
            </button>
            <div *ngIf="otherDocUploadError" class="alert alert-error">{{ otherDocUploadError }}</div>
          </div>

          <div *ngIf="otherDocuments.length > 0" class="other-documents-list">
            <h4>Dodane dokumenty:</h4>
            <div *ngFor="let doc of otherDocuments; let i = index" class="uploaded-file-info">
              <div class="file-status">
                ‚úÖ <strong>{{ doc.documentName }}</strong>: {{ doc.filename }}
              </div>
              <div class="file-actions">
                <button type="button" (click)="deleteOtherDocFile(i)" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr>

      <h3>Za≈ÇƒÖcznik PDF (dodatkowy)</h3>
      <p class="field-description">Mo≈ºesz za≈ÇƒÖczyƒá dodatkowy plik PDF (maksymalnie 10MB)</p>

      <div class="file-upload-section">
        <div *ngIf="!uploadedFileName" class="file-input-wrapper">
          <div class="form-group">
            <label for="fileInput" class="file-label">Wybierz plik PDF</label>
            <input
              type="file"
              id="fileInput"
              accept="application/pdf"
              (change)="onFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedFile.name }} ({{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB)
            </div>
          </div>

          <button
            type="button"
            (click)="uploadFile()"
            [disabled]="!selectedFile || isUploadingFile || !savedDraftId"
            class="btn btn-primary">
            {{ isUploadingFile ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
          </button>

          <div *ngIf="fileUploadError" class="alert alert-error">
            {{ fileUploadError }}
          </div>
        </div>

        <div *ngIf="uploadedFileName" class="uploaded-file-info">
          <div class="file-status">
            ‚úÖ Za≈ÇƒÖczony plik: <strong>{{ uploadedFileName }}</strong>
          </div>
          <div class="file-actions">
            <button
              type="button"
              (click)="downloadFile()"
              class="btn btn-secondary">
              üì• Pobierz
            </button>
            <button
              type="button"
              (click)="deleteFile()"
              class="btn btn-danger">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Krok 6: Podpis i wys≈Çanie -->
    <div *ngIf="currentStep === 6" class="form-step">
      <h2>Podpis i wys≈Çanie zg≈Çoszenia</h2>

      <div class="form-group">
        <label>Spos√≥b odbioru odpowiedzi *</label>
        <select formControlName="responseDeliveryMethod" class="form-control">
          <option value="">Wybierz...</option>
          <option value="PICKUP_AT_ZUS">W plac√≥wce ZUS (osobi≈õcie lub przez osobƒô upowa≈ºnionƒÖ)</option>
          <option value="BY_MAIL_TO_ADDRESS">PocztƒÖ na adres korespondencyjny</option>
          <option value="TO_PUE_ACCOUNT">Na konto na Platformie Us≈Çug Elektronicznych (PUE ZUS)</option>
        </select>
      </div>

      <div formGroupName="signature">
        <div class="form-group">
          <label>Data z≈Ço≈ºenia o≈õwiadczenia *</label>
          <input type="date" formControlName="declarationDate" class="form-control">
        </div>

        <div class="form-group">
          <label>Czytelny podpis (imiƒô i nazwisko) *</label>
          <input type="text" formControlName="signatureName" class="form-control">
        </div>
      </div>

      <div *ngIf="errorMessage" class="alert alert-error">
        WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania zg≈Çoszenia: {{ errorMessage }}
      </div>

      <div *ngIf="submittedReportId" class="alert alert-success">
        Zg≈Çoszenie zosta≈Ço pomy≈õlnie z≈Ço≈ºone. Identyfikator zg≈Çoszenia: {{ submittedReportId }}
      </div>
    </div>

    <!-- Messages -->
    <div *ngIf="draftSaveMessage" class="alert alert-success">
      {{ draftSaveMessage }}
    </div>

    <!-- Nawigacja -->
    <div class="form-navigation">
      <button type="button"
              *ngIf="currentStep > 0"
              (click)="previousStep()"
              class="btn btn-secondary">
        Wstecz
      </button>

      <button type="button"
              *ngIf="currentStep > 0"
              (click)="saveDraft()"
              [disabled]="isSavingDraft"
              class="btn btn-info">
        {{ isSavingDraft ? 'Zapisywanie...' : 'Zapisz wersjƒô roboczƒÖ' }}
      </button>

      <button type="button"
              *ngIf="currentStep < totalSteps - 1"
              (click)="nextStep()"
              class="btn btn-primary">
        Dalej
      </button>

      <!-- Document Generation Button -->
      <div *ngIf="currentStep === totalSteps - 1 && savedDraftId" class="document-generation">
        <button type="button"
                (click)="toggleFormatSelection()"
                [disabled]="isGeneratingDocument"
                class="btn btn-warning">
          {{ isGeneratingDocument ? 'üìÑ Generowanie...' : 'üìÑ Generuj Zawiadomienie o wypadku' }}
        </button>

        <!-- Format Selection Dropdown -->
        <div *ngIf="showFormatSelection" class="format-selection-dropdown">
          <h4>Wybierz format dokumentu:</h4>
          <button type="button"
                  (click)="generateAndDownloadDocument('docx')"
                  class="btn btn-format">
            üìù DOCX (Word)
          </button>
          <button type="button"
                  (click)="generateAndDownloadDocument('pdf')"
                  class="btn btn-format">
            üìÑ PDF
          </button>
          <button type="button"
                  (click)="toggleFormatSelection()"
                  class="btn btn-cancel">
            Anuluj
          </button>
        </div>
      </div>

      <button type="submit"
              *ngIf="currentStep === totalSteps - 1"
              [disabled]="isSubmitting"
              class="btn btn-success">
        {{ isSubmitting ? 'Trwa wysy≈Çanie...' : 'Z≈Ç√≥≈º zg≈Çoszenie' }}
      </button>
    </div>
  </form>
</div>
