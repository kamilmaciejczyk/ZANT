<div class="ewyp-form-container">
  <h1>Formularz zg≈Çoszenia wypadku EWYP</h1>

  <div class="progress-indicator">
    <div class="steps">
      <div *ngFor="let step of [1,2,3,4,5,6]"
           [class.active]="currentStep === step"
           [class.completed]="currentStep > step"
           class="step">
        <div class="step-number">{{ step }}</div>
      </div>
    </div>
    <div class="step-title">{{ getStepTitle() }}</div>
  </div>

  <form [formGroup]="reportForm" (ngSubmit)="onSubmit()">

    <!-- Krok 1: Dane osoby poszkodowanej -->
    <div *ngIf="currentStep === 1" class="form-step" formGroupName="injuredPerson">
      <h2>Dane osoby poszkodowanej</h2>

      <div class="form-group">
        <label>PESEL *</label>
        <input type="text" formControlName="pesel" class="form-control">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Imiƒô *</label>
          <input type="text" formControlName="firstName" class="form-control">
        </div>
        <div class="form-group">
          <label>Nazwisko *</label>
          <input type="text" formControlName="lastName" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Rodzaj dokumentu to≈ºsamo≈õci</label>
          <input type="text" formControlName="idDocumentType" class="form-control">
        </div>
        <div class="form-group">
          <label>Numer dokumentu to≈ºsamo≈õci</label>
          <input type="text" formControlName="idDocumentNumber" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Data urodzenia</label>
          <input type="date" formControlName="birthDate" class="form-control">
        </div>
        <div class="form-group">
          <label>Miejsce urodzenia</label>
          <input type="text" formControlName="birthPlace" class="form-control">
        </div>
      </div>

      <div class="form-group">
        <label>Numer telefonu</label>
        <input type="tel" formControlName="phoneNumber" class="form-control">
      </div>

      <h3>Adres zamieszkania osoby poszkodowanej</h3>
      <div formGroupName="address">
        <div class="form-row">
          <div class="form-group">
            <label>Ulica</label>
            <input type="text" formControlName="street" class="form-control">
          </div>
          <div class="form-group">
            <label>Numer domu</label>
            <input type="text" formControlName="houseNumber" class="form-control">
          </div>
          <div class="form-group">
            <label>Numer lokalu</label>
            <input type="text" formControlName="apartmentNumber" class="form-control">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Kod pocztowy</label>
            <input type="text" formControlName="postalCode" class="form-control">
          </div>
          <div class="form-group">
            <label>Miejscowo≈õƒá</label>
            <input type="text" formControlName="city" class="form-control">
          </div>
          <div class="form-group">
            <label>Nazwa pa≈Ñstwa</label>
            <input type="text" formControlName="country" class="form-control">
          </div>
        </div>
      </div>
    </div>

    <!-- Krok 2: Dane osoby zg≈ÇaszajƒÖcej wypadek -->
    <div *ngIf="currentStep === 2" class="form-step" formGroupName="reporter">
      <h2>Dane osoby zg≈ÇaszajƒÖcej wypadek</h2>

      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="isDifferentFromInjuredPerson">
          Zg≈ÇaszajƒÖcy jest innƒÖ osobƒÖ ni≈º poszkodowany
        </label>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Imiƒô</label>
          <input type="text" formControlName="firstName" class="form-control">
        </div>
        <div class="form-group">
          <label>Nazwisko</label>
          <input type="text" formControlName="lastName" class="form-control">
        </div>
      </div>

      <div class="form-group">
        <label>PESEL</label>
        <input type="text" formControlName="pesel" class="form-control">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Rodzaj dokumentu to≈ºsamo≈õci</label>
          <input type="text" formControlName="idDocumentType" class="form-control">
        </div>
        <div class="form-group">
          <label>Numer dokumentu to≈ºsamo≈õci</label>
          <input type="text" formControlName="idDocumentNumber" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Data urodzenia</label>
          <input type="date" formControlName="birthDate" class="form-control">
        </div>
        <div class="form-group">
          <label>Numer telefonu</label>
          <input type="tel" formControlName="phoneNumber" class="form-control">
        </div>
      </div>
    </div>

    <!-- Krok 3: Informacje o wypadku -->
    <div *ngIf="currentStep === 3" class="form-step" formGroupName="accidentInfo">
      <h2>Informacje o wypadku</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Data wypadku *</label>
          <input type="date" formControlName="accidentDate" class="form-control">
        </div>
        <div class="form-group">
          <label>Godzina wypadku</label>
          <input type="time" formControlName="accidentTime" class="form-control">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Planowana godzina rozpoczƒôcia pracy</label>
          <input type="time" formControlName="plannedWorkStartTime" class="form-control">
        </div>
        <div class="form-group">
          <label>Planowana godzina zako≈Ñczenia pracy</label>
          <input type="time" formControlName="plannedWorkEndTime" class="form-control">
        </div>
      </div>

      <div class="form-group">
        <label>Miejsce wypadku</label>
        <textarea formControlName="placeOfAccident" class="form-control" rows="2"></textarea>
      </div>

      <div class="form-group">
        <label>Opis doznanego urazu</label>
        <textarea formControlName="injuriesDescription" class="form-control" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label>Okoliczno≈õci i przyczyny zdarzenia *</label>
        <p class="field-description">Opisz szczeg√≥≈Çowo co siƒô sta≈Ço, jak dosz≈Ço do wypadku i jakie by≈Çy jego przyczyny (minimum 50 znak√≥w).</p>
        <textarea formControlName="circumstancesAndCauses" class="form-control" rows="3"></textarea>

        <button type="button"
                (click)="checkCircumstancesDescription()"
                [disabled]="isLoadingQuestions"
                class="btn btn-info btn-assistant">
          <span *ngIf="!isLoadingQuestions">ü§ñ Asystent AI - sprawd≈∫ opis</span>
          <span *ngIf="isLoadingQuestions">‚è≥ Trwa sprawdzanie...</span>
        </button>

        <!-- AI Assistant Suggestions -->
        <div *ngIf="showCircumstancesAssistant" class="assistant-suggestions">
          <div *ngIf="isLoadingQuestions" class="loading-message">
            Asystent AI analizuje opis zdarzenia...
          </div>

          <div *ngIf="!isLoadingQuestions && !!circumstancesQuestionsError" class="error-message">
            {{ circumstancesQuestionsError }}
          </div>

          <div *ngIf="!isLoadingQuestions && !circumstancesQuestionsError && circumstancesQuestions.length > 0" class="questions-container">
            <h4>üìã Sugestie Asystenta AI</h4>
            <p class="assistant-intro">Aby doprecyzowaƒá opis zdarzenia, rozwa≈º odpowied≈∫ na poni≈ºsze pytania:</p>
            <ul class="questions-list">
              <li *ngFor="let question of circumstancesQuestions" class="question-item">
                <strong>{{ question.id }}.</strong> {{ question.text }}
              </li>
            </ul>
          </div>

          <div *ngIf="!isLoadingQuestions && circumstancesQuestions.length === 0 && !circumstancesQuestionsError" class="no-questions-message">
            ‚úÖ Opis zdarzenia jest wystarczajƒÖco szczeg√≥≈Çowy. Nie ma dodatkowych pyta≈Ñ.
          </div>

        </div>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="firstAidGiven">
          Udzielono pierwszej pomocy
        </label>
      </div>

      <div class="form-group">
        <label>Miejsce udzielenia pierwszej pomocy</label>
        <input type="text" formControlName="firstAidFacility" class="form-control">
      </div>

      <div class="form-group">
        <label>Organ prowadzƒÖcy czynno≈õci wyja≈õniajƒÖce</label>
        <input type="text" formControlName="investigatingAuthority" class="form-control">
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="accidentDuringMachineOperation">
          Wypadek podczas obs≈Çugi maszyny
        </label>
      </div>

      <div class="form-group">
        <label>Opis stanu technicznego i u≈ºytkowania maszyny</label>
        <textarea formControlName="machineConditionDescription" class="form-control" rows="2"></textarea>
      </div>
    </div>

    <!-- Krok 4: ≈öwiadkowie -->
    <div *ngIf="currentStep === 4" class="form-step">
      <h2>≈öwiadkowie wypadku</h2>

      <div formArrayName="witnesses">
        <div *ngFor="let witness of witnesses.controls; let i = index" [formGroupName]="i" class="witness-group">
          <h3>≈öwiadek wypadku ‚Äì {{ i + 1 }}</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Imiƒô</label>
              <input type="text" formControlName="firstName" class="form-control">
            </div>
            <div class="form-group">
              <label>Nazwisko</label>
              <input type="text" formControlName="lastName" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ulica</label>
              <input type="text" formControlName="street" class="form-control">
            </div>
            <div class="form-group">
              <label>Numer domu</label>
              <input type="text" formControlName="houseNumber" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Miejscowo≈õƒá</label>
              <input type="text" formControlName="city" class="form-control">
            </div>
            <div class="form-group">
              <label>Kod pocztowy</label>
              <input type="text" formControlName="postalCode" class="form-control">
            </div>
          </div>
          <button type="button" (click)="removeWitness(i)" class="btn btn-danger">Usu≈Ñ ≈õwiadka</button>
        </div>
      </div>

      <button type="button" (click)="addWitness()" class="btn btn-secondary">Dodaj ≈õwiadka</button>
    </div>

    <!-- Krok 5: Dokumenty i za≈ÇƒÖczniki -->
    <div *ngIf="currentStep === 5" class="form-step" formGroupName="attachments">
      <h2>Dokumenty i za≈ÇƒÖczniki</h2>

      <div *ngIf="!savedDraftId" class="alert alert-warning">
        Najpierw zapisz wersjƒô roboczƒÖ, aby m√≥c za≈ÇƒÖczyƒá pliki.
      </div>

      <!-- Hospital Card Copy -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasHospitalCardCopy">
          Kserokopia karty informacyjnej ze szpitala / za≈õwiadczenia o udzieleniu pierwszej pomocy
        </label>

        <div *ngIf="reportForm.get('attachments.hasHospitalCardCopy')?.value" class="file-upload-section">
          <div *ngIf="!reportForm.get('attachments.hospitalCardCopyFilename')?.value" class="file-input-wrapper">
            <input
              type="file"
              accept="application/pdf"
              (change)="onHospitalCardFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedHospitalCardFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedHospitalCardFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadHospitalCardFile()"
              [disabled]="!selectedHospitalCardFile || isUploadingHospitalCard || !savedDraftId"
              class="btn btn-primary btn-sm">
              {{ isUploadingHospitalCard ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
            </button>
            <div *ngIf="hospitalCardUploadError" class="alert alert-error">{{ hospitalCardUploadError }}</div>
          </div>

          <div *ngIf="reportForm.get('attachments.hospitalCardCopyFilename')?.value" class="uploaded-file-info">
            <div class="file-status">
              ‚úÖ Za≈ÇƒÖczony: <strong>{{ reportForm.get('attachments.hospitalCardCopyFilename')?.value }}</strong>
            </div>
            <div class="file-actions">
              <button type="button" (click)="downloadHospitalCardFile()" class="btn btn-secondary btn-sm">üì• Pobierz</button>
              <button type="button" (click)="deleteHospitalCardFile()" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Prosecutor Decision Copy -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasProsecutorDecisionCopy">
          Kserokopia postanowienia prokuratury
        </label>

        <div *ngIf="reportForm.get('attachments.hasProsecutorDecisionCopy')?.value" class="file-upload-section">
          <div *ngIf="!reportForm.get('attachments.prosecutorDecisionCopyFilename')?.value" class="file-input-wrapper">
            <input
              type="file"
              accept="application/pdf"
              (change)="onProsecutorDecisionFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedProsecutorDecisionFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedProsecutorDecisionFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadProsecutorDecisionFile()"
              [disabled]="!selectedProsecutorDecisionFile || isUploadingProsecutorDecision || !savedDraftId"
              class="btn btn-primary btn-sm">
              {{ isUploadingProsecutorDecision ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
            </button>
            <div *ngIf="prosecutorDecisionUploadError" class="alert alert-error">{{ prosecutorDecisionUploadError }}</div>
          </div>

          <div *ngIf="reportForm.get('attachments.prosecutorDecisionCopyFilename')?.value" class="uploaded-file-info">
            <div class="file-status">
              ‚úÖ Za≈ÇƒÖczony: <strong>{{ reportForm.get('attachments.prosecutorDecisionCopyFilename')?.value }}</strong>
            </div>
            <div class="file-actions">
              <button type="button" (click)="downloadProsecutorDecisionFile()" class="btn btn-secondary btn-sm">üì• Pobierz</button>
              <button type="button" (click)="deleteProsecutorDecisionFile()" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Death Docs Copy -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasDeathDocsCopy">
          Kopie dokument√≥w dotyczƒÖcych zgonu
        </label>

        <div *ngIf="reportForm.get('attachments.hasDeathDocsCopy')?.value" class="file-upload-section">
          <div *ngIf="!reportForm.get('attachments.deathDocsCopyFilename')?.value" class="file-input-wrapper">
            <input
              type="file"
              accept="application/pdf"
              (change)="onDeathDocsFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedDeathDocsFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedDeathDocsFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadDeathDocsFile()"
              [disabled]="!selectedDeathDocsFile || isUploadingDeathDocs || !savedDraftId"
              class="btn btn-primary btn-sm">
              {{ isUploadingDeathDocs ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
            </button>
            <div *ngIf="deathDocsUploadError" class="alert alert-error">{{ deathDocsUploadError }}</div>
          </div>

          <div *ngIf="reportForm.get('attachments.deathDocsCopyFilename')?.value" class="uploaded-file-info">
            <div class="file-status">
              ‚úÖ Za≈ÇƒÖczony: <strong>{{ reportForm.get('attachments.deathDocsCopyFilename')?.value }}</strong>
            </div>
            <div class="file-actions">
              <button type="button" (click)="downloadDeathDocsFile()" class="btn btn-secondary btn-sm">üì• Pobierz</button>
              <button type="button" (click)="deleteDeathDocsFile()" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Other Documents -->
      <div class="form-group document-upload-group">
        <label>
          <input type="checkbox" formControlName="hasOtherDocuments">
          Inne dokumenty
        </label>

        <div *ngIf="reportForm.get('attachments.hasOtherDocuments')?.value" class="file-upload-section">
          <div class="file-input-wrapper">
            <div class="form-group">
              <label>Nazwa dokumentu:</label>
              <input
                type="text"
                [(ngModel)]="otherDocumentName"
                [ngModelOptions]="{standalone: true}"
                placeholder="Np. Za≈õwiadczenie lekarskie"
                class="form-control">
            </div>
            <input
              type="file"
              accept="application/pdf"
              (change)="onOtherDocFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedOtherDocFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedOtherDocFile.name }}
            </div>
            <button
              type="button"
              (click)="uploadOtherDocFile()"
              [disabled]="!selectedOtherDocFile || isUploadingOtherDoc || !savedDraftId || !otherDocumentName.trim()"
              class="btn btn-primary btn-sm">
              {{ isUploadingOtherDoc ? 'Przesy≈Çanie...' : 'Dodaj dokument' }}
            </button>
            <div *ngIf="otherDocUploadError" class="alert alert-error">{{ otherDocUploadError }}</div>
          </div>

          <div *ngIf="otherDocuments.length > 0" class="other-documents-list">
            <h4>Dodane dokumenty:</h4>
            <div *ngFor="let doc of otherDocuments; let i = index" class="uploaded-file-info">
              <div class="file-status">
                ‚úÖ <strong>{{ doc.documentName }}</strong>: {{ doc.filename }}
              </div>
              <div class="file-actions">
                <button type="button" (click)="deleteOtherDocFile(i)" class="btn btn-danger btn-sm">üóëÔ∏è Usu≈Ñ</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr>

      <h3>Za≈ÇƒÖcznik PDF (dodatkowy)</h3>
      <p class="field-description">Mo≈ºesz za≈ÇƒÖczyƒá dodatkowy plik PDF (maksymalnie 10MB)</p>

      <div class="file-upload-section">
        <div *ngIf="!uploadedFileName" class="file-input-wrapper">
          <div class="form-group">
            <label for="fileInput" class="file-label">Wybierz plik PDF</label>
            <input
              type="file"
              id="fileInput"
              accept="application/pdf"
              (change)="onFileSelected($event)"
              class="file-input">
            <div *ngIf="selectedFile" class="selected-file-info">
              ‚úì Wybrany plik: {{ selectedFile.name }} ({{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB)
            </div>
          </div>

          <button
            type="button"
            (click)="uploadFile()"
            [disabled]="!selectedFile || isUploadingFile || !savedDraftId"
            class="btn btn-primary">
            {{ isUploadingFile ? 'Przesy≈Çanie...' : 'Prze≈õlij plik' }}
          </button>

          <div *ngIf="fileUploadError" class="alert alert-error">
            {{ fileUploadError }}
          </div>
        </div>

        <div *ngIf="uploadedFileName" class="uploaded-file-info">
          <div class="file-status">
            ‚úÖ Za≈ÇƒÖczony plik: <strong>{{ uploadedFileName }}</strong>
          </div>
          <div class="file-actions">
            <button
              type="button"
              (click)="downloadFile()"
              class="btn btn-secondary">
              üì• Pobierz
            </button>
            <button
              type="button"
              (click)="deleteFile()"
              class="btn btn-danger">
              üóëÔ∏è Usu≈Ñ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Krok 6: Podpis i wys≈Çanie -->
    <div *ngIf="currentStep === 6" class="form-step">
      <h2>Podpis i wys≈Çanie zg≈Çoszenia</h2>

      <div class="form-group">
        <label>Spos√≥b odbioru odpowiedzi *</label>
        <select formControlName="responseDeliveryMethod" class="form-control">
          <option value="">Wybierz...</option>
          <option value="PICKUP_AT_ZUS">W plac√≥wce ZUS (osobi≈õcie lub przez osobƒô upowa≈ºnionƒÖ)</option>
          <option value="BY_MAIL_TO_ADDRESS">PocztƒÖ na adres korespondencyjny</option>
          <option value="TO_PUE_ACCOUNT">Na konto na Platformie Us≈Çug Elektronicznych (PUE ZUS)</option>
        </select>
      </div>

      <div formGroupName="signature">
        <div class="form-group">
          <label>Data z≈Ço≈ºenia o≈õwiadczenia *</label>
          <input type="date" formControlName="declarationDate" class="form-control">
        </div>

        <div class="form-group">
          <label>Czytelny podpis (imiƒô i nazwisko) *</label>
          <input type="text" formControlName="signatureName" class="form-control">
        </div>
      </div>

      <div *ngIf="errorMessage" class="alert alert-error">
        WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania zg≈Çoszenia: {{ errorMessage }}
      </div>

      <div *ngIf="submittedReportId" class="alert alert-success">
        Zg≈Çoszenie zosta≈Ço pomy≈õlnie z≈Ço≈ºone. Identyfikator zg≈Çoszenia: {{ submittedReportId }}
      </div>
    </div>

    <!-- Messages -->
    <div *ngIf="draftSaveMessage" class="alert alert-success">
      {{ draftSaveMessage }}
    </div>

    <!-- Nawigacja -->
    <div class="form-navigation">
      <button type="button"
              *ngIf="currentStep > 1"
              (click)="previousStep()"
              class="btn btn-secondary">
        Wstecz
      </button>

      <button type="button"
              (click)="saveDraft()"
              [disabled]="isSavingDraft"
              class="btn btn-info">
        {{ isSavingDraft ? 'Zapisywanie...' : 'Zapisz wersjƒô roboczƒÖ' }}
      </button>

      <button type="button"
              *ngIf="currentStep < totalSteps"
              (click)="nextStep()"
              class="btn btn-primary">
        Dalej
      </button>

      <button type="submit"
              *ngIf="currentStep === totalSteps"
              [disabled]="isSubmitting"
              class="btn btn-success">
        {{ isSubmitting ? 'Trwa wysy≈Çanie...' : 'Z≈Ç√≥≈º zg≈Çoszenie' }}
      </button>
    </div>
  </form>
</div>
